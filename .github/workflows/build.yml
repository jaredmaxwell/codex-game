name: Build Game

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
    
    - name: Setup vcpkg
      run: |
        git clone https://github.com/Microsoft/vcpkg.git
        .\vcpkg\bootstrap-vcpkg.bat
    
    - name: Install dependencies
      run: |
        .\vcpkg\vcpkg.exe install --triplet=x64-windows
    
    - name: Build with CMake
      run: |
        cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}\vcpkg\scripts\buildsystems\vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows
        cmake --build build --config Release
        
    - name: Upload Windows build
      uses: actions/upload-artifact@v4
      with:
        name: game-windows
        path: build/Release/game.exe

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install SDL2 dependencies
      run: |
        brew install sdl2 sdl2_ttf sdl2_image pkg-config
        
    - name: Debug SDL2 paths
      run: |
        echo "Homebrew prefix: $(brew --prefix)"
        echo "SDL2 include path: $(brew --prefix sdl2)/include"
        echo "SDL2_ttf include path: $(brew --prefix sdl2_ttf)/include"
        echo "SDL2_image include path: $(brew --prefix sdl2_image)/include"
        find $(brew --prefix) -name "SDL.h" 2>/dev/null || echo "SDL.h not found"
        find $(brew --prefix) -name "SDL_ttf.h" 2>/dev/null || echo "SDL_ttf.h not found"
        find $(brew --prefix) -name "SDL_image.h" 2>/dev/null || echo "SDL_image.h not found"
        
    - name: Build for macOS
      run: |
        make -f Makefile.macos
        mv game game-macos
        chmod +x game-macos
        
    - name: Upload macOS build
      uses: actions/upload-artifact@v4
      with:
        name: game-macos
        path: game-macos

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install SDL2 dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends libsdl2-dev libsdl2-ttf-dev libsdl2-image-dev
        
    - name: Build for Linux
      run: |
        make -f Makefile.linux
        mv game game-linux
        chmod +x game-linux
        
    - name: Upload Linux build
      uses: actions/upload-artifact@v4
      with:
        name: game-linux
        path: game-linux

  build-web:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Emscripten
      run: |
        git clone https://github.com/emscripten-core/emsdk.git
        cd emsdk
        ./emsdk install latest
        ./emsdk activate latest
        echo "EMSDK_PATH=$PWD" >> $GITHUB_ENV
        echo "$PWD" >> $GITHUB_PATH
        
    - name: Build for WebAssembly
      run: |
        source $EMSDK_PATH/emsdk_env.sh
        mkdir build-web
        cd build-web
        emcmake cmake .. -DCMAKE_BUILD_TYPE=Release
        emmake make -j$(nproc)
        
    - name: Upload WebAssembly build
      uses: actions/upload-artifact@v4
      with:
        name: game-web
        path: build-web/

  create-release:
    needs: [build-windows, build-macos, build-linux, build-web]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    permissions:
      contents: write
    steps:
    - name: Download Windows build
      uses: actions/download-artifact@v4
      with:
        name: game-windows
        path: ./releases/windows/
        
    - name: Download macOS build
      uses: actions/download-artifact@v4
      with:
        name: game-macos
        path: ./releases/macos/
        
    - name: Download Linux build
      uses: actions/download-artifact@v4
      with:
        name: game-linux
        path: ./releases/linux/
        
    - name: Download WebAssembly build
      uses: actions/download-artifact@v4
      with:
        name: game-web
        path: ./releases/web/
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Codex Game v${{ github.run_number }}
        body: |
          ## Codex Game Release v${{ github.run_number }}
          
          Cross-platform builds for Windows, macOS, and Linux.
          
          ### Downloads:
          - **Windows**: `game.exe` - Run directly on Windows
          - **macOS**: `game-macos` - Run directly on macOS
          - **Linux**: `game-linux` - Run directly on Linux
          - **Web**: `game.html` + supporting files - Open in any modern web browser (works on mobile too!)
          
          ### Controls:
          - **Desktop**: WASD to move, J to attack, ESC to quit
          - **Mobile/Web**: Touch and drag to move, tap to attack
          
          ### Game Features:
          - Dynamic enemy spawning and leveling
          - Shard collection system
          - Magnet power-ups
          - Cross-platform compatibility (Desktop + Web)
        files: |
          ./releases/windows/game.exe
          ./releases/macos/game-macos
          ./releases/linux/game-linux
          ./releases/web/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
